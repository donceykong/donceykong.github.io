{% assign width=800 %} 
{% assign height=350 %} 
{% if include.width %} 
  {% assign width = include.width %} 
{% endif %} 
{% if include.height %} 
  {% assign height = include.height %} 
{% endif %} 
{% capture url %}/assets/stl/{{include.src}}{% endcapture %} 
{% capture style %}width: {{width}}px; height: {{height}}px; -webkit-box-shadow: 3px 0px 10px 0px #000000; box-shadow: 3px 0px 10px 0px #000000; {% if include.extrastyle %}{{include.extrastyle}}{% endif %}{% endcapture %}

<div id="stl-viewer-{{ include.src | slugify }}" style="{{ style }}"></div>

<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>

<script>
  (function() {
    var container = document.getElementById('stl-viewer-{{ include.src | slugify }}');
    var width = {{ width }};
    var height = {{ height }};
    
    var scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    
    var camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
    camera.position.set(0, 0, 150);
    
    var renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(width, height);
    container.appendChild(renderer.domElement);
    
    // Lighting
    var ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    
    var directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight1.position.set(1, 1, 1);
    scene.add(directionalLight1);
    
    var directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.3);
    directionalLight2.position.set(-1, -1, -1);
    scene.add(directionalLight2);
    
    // Load STL
    var loader = new THREE.STLLoader();
    loader.load('{{ url }}', function(geometry) {
      var material = new THREE.MeshPhongMaterial({ 
        color: 0x888888,
        specular: 0x111111,
        shininess: 200
      });
      
      var mesh = new THREE.Mesh(geometry, material);
      
      // Center and scale the geometry
      geometry.computeBoundingBox();
      var center = new THREE.Vector3();
      geometry.boundingBox.getCenter(center);
      geometry.translate(-center.x, -center.y, -center.z);
      
      // Calculate size and scale
      var size = new THREE.Vector3();
      geometry.boundingBox.getSize(size);
      var maxDim = Math.max(size.x, size.y, size.z);
      var scale = 80 / maxDim;
      mesh.scale.set(scale, scale, scale);
      
      scene.add(mesh);
    });
    
    // Controls
    var controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  })();
</script>
