<div class="stl-viewer" style="{{ include.extrastyle }}">
  <div id="stl-container-{{ include.src | slugify }}" 
       style="width: {{ include.width }}px; height: {{ include.height }}px; margin: 0 auto; background: #f0f0f0; border-radius: 4px;">
  </div>
  
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { STLLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/STLLoader.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    
    const container = document.getElementById('stl-container-{{ include.src | slugify }}');
    const width = {{ include.width }};
    const height = {{ include.height }};
    
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    
    const camera = new THREE.PerspectiveCamera(75, width/height, 0.1, 1000);
    camera.position.set(0, 0, 100);
    
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(width, height);
    container.appendChild(renderer.domElement);
    
    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    
    const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight1.position.set(1, 1, 1);
    scene.add(directionalLight1);
    
    const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.3);
    directionalLight2.position.set(-1, -1, -1);
    scene.add(directionalLight2);
    
    // Load STL
    const loader = new STLLoader();
    loader.load('{{ include.src | relative_url }}', function(geometry) {
      const material = new THREE.MeshPhongMaterial({ 
        color: 0x888888,
        specular: 0x111111,
        shininess: 200
      });
      
      const mesh = new THREE.Mesh(geometry, material);
      
      // Center and scale the geometry
      geometry.computeBoundingBox();
      const center = new THREE.Vector3();
      geometry.boundingBox.getCenter(center);
      geometry.translate(-center.x, -center.y, -center.z);
      
      // Calculate size and scale appropriately
      const size = new THREE.Vector3();
      geometry.boundingBox.getSize(size);
      const maxDim = Math.max(size.x, size.y, size.z);
      const scale = 50 / maxDim;
      mesh.scale.set(scale, scale, scale);
      
      scene.add(mesh);
    }, undefined, function(error) {
      console.error('Error loading STL:', error);
    });
    
    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</div>

